{% extends "base.html" %}
{% block content %}
    {% if document._id %}
        <form action = "/documents/{{ document._id }}/results" method = "POST">
            <tr>
                <td style="width:7em;"><input style="width:7em;" class= "ui-button ui-widget ui-corner-all" type="submit" name="submit" value="<< previous"></td>
                <td style="width:7em;"><input style="width:7em;" class= "ui-button ui-widget ui-corner-all" type="submit" name="submit" value="next >>"></td>
            </tr>

            <h2>Document: {{ document._id }}</h2>
            {% if result %}
                Measurement:
                <select id="measure-type" name="measure-type">
                    <option value="strict">Strict</option>
                    <option value="approximate">Approximate</option>
                    <option value="one_all" selected>One vs. All</option>
                </select>
                <table id="measure-settings" style="visibility: visible;">
                    <tr>
                        <td></td>
                        <td>Threshold:</td>
                        <td style="width:25px; height:15px"><input id="threshold" name="value" style="width:25px; height:15px" readonly></td>
                        <td>Boundary:</td>
                        <td style="width:25px; height:15px"><input id="boundary" name="value" style="width:25px; height:15px" readonly></td>
                        <td></td>
                        <td style="height:25px"><button class="ui-button ui-widget ui-corner-all" id="setvalues" style="height:25px; font-size:9pt">Confirm</button></td>
                    </tr>
                </table>
                Trigger Type:
                <select id="trigger-type" name="trigger-type">
                    <option value="medication" selected>Medication</option>
                    <option value="dose">Dose</option>
                    <option value="modus">Modus</option>
                    <option value="frequency">Frequency</option>
                    <option value="duration">Duration</option>
                    <option value="reason">Reason</option>
                </select>
                <br><br>
                <div id="table-result">
                    {{ result._table|safe }}
                </div>
                {% block result_content %} {% endblock %}
            {% else %}
                No Result
            {% endif %}
        </form>
        {% if sentences %}
            <h3>Sentences:</h3>
            <div id="sentence-vis">
                <button class="ui-button ui-widget ui-corner-all" id="prev-sent"> << </button>
                <button class="ui-button ui-widget ui-corner-all" id="next-sent"> >> </button>
                <br><br>
                {% block sentence_content %} {% endblock %}
            </div>
        {% else %}
            No Sentences
        {% endif %}
        <script>
            head(function() {
                var socket = io.connect('http://' + document.domain + ':' + location.port);

                // prevents button to call "submit"
                // original line (as of jquery-ui doc) was:
                //      $( ".widget input[type=submit], .widget a, .widget button" ).button();
                //      $( "button, input, a" ).click( function( event ) {
                $( function() {
                    $( ".widget button" ).button();
                    $( "button" ).click( function( event ) {
                      event.preventDefault();
                    } );
                } );

                // creates spinner and confirmation button
                var threshold = $("#threshold").spinner();
                var boundary = $("#boundary").spinner();
                var annotators = {{ annotators|tojson }};

                threshold.val(0);
                threshold.spinner( "option", "min", 0 );
                threshold.spinner( "option", "max", annotators.length - 1 );
                boundary.val(0);
                boundary.spinner( "option", "min", 0 );
                boundary.spinner( "option", "max", annotators.length - 2 );

                $( "#setvalues" ).on( "click", function() {
                    socket.emit('change table',
                        {'threshold': threshold.spinner("value"),
                        'boundary': boundary.spinner("value"),
                        'ttype': $('#trigger-type').val(),
                        'mtype': "one_all"});
                });

                // dispatches new data to the sentence visualizers
                socket.on('vis sentence', function(data) {
                    var sentence = data._sentence
                    var entities = data._entities
                    $(entities).each(function () {
                        var that = $(this)[0]
                        var docData = {
                            // Our text of choice
                            text     : sentence,
                            // The entities entry holds all entity annotations
                            entities : that.entities,
                        };
                        var d = dispatchers['dispatcher_' + that.id]
                        d.post('requestRenderData', [$.extend({}, docData)]);
                    });
                });

                // sends new table data to table div
                socket.on('ch table', function(data) {
                    $('#table-result').html(data)
                });

                // triggers the 'cycle sentence' function in 'views.py'
                $('#sentence-vis').on('click', '#next-sent', function(event) {
                    socket.emit('cycle sentences', "next");
                });
                $('#sentence-vis').on('click', '#prev-sent', function(event) {
                    socket.emit('cycle sentences', "previous");
                });

                // triggers the 'change table' function in 'views.py'
                $('#measure-type').change(function() {
                    socket.emit('change table',
                     {'threshold': threshold.spinner("value"),
                      'boundary': boundary.spinner("value"),
                      'mtype': this.value,
                      'ttype': $('#trigger-type').val() });
                    if (this.value === "one_all") {
                        $('#measure-settings').css('visibility', 'visible');
                    } else {
                        $('#measure-settings').css('visibility', 'hidden');
                    }
                });
                $('#trigger-type').change(function() {
                    socket.emit('change table',
                     {'threshold': threshold.spinner("value"),
                      'boundary': boundary.spinner("value"),
                      'mtype': $('#measure-type').val(),
                      'ttype': this.value});
                });
            });
        </script>
    {% else %}
        <h2>Document: {{ document }}</h2>
        No such Document
    {% endif %}
{% endblock %}